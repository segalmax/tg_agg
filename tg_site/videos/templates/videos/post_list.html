{% extends 'videos/base.html' %}

{% block title %}
    {% if channel %}{{ channel.username }} - Telegram Videos{% else %}Telegram Videos{% endif %}
{% endblock %}

{% block extra_css %}
<style>
.video-card {
    cursor: pointer;
}
.video-card .video-thumbnail {
    height: 280px;
    object-fit: cover;
}
.video-card .preview-video {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 280px;
    object-fit: cover;
    display: none;
    z-index: 10;
}
.video-card:hover .preview-video.loaded {
    display: block;
}
#videoModal .modal-dialog {
    max-width: 90vw;
}
#videoModal video {
    width: 100%;
    max-height: 80vh;
    background: #000;
}
.fallback-container {
    min-height: 400px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #1a1a1a;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Desktop Sidebar (hidden on mobile) -->
        <div class="col-md-3 col-lg-2 d-none d-md-block bg-white p-3 sticky-top" style="top: 56px; height: calc(100vh - 56px); overflow-y: auto;">
            {% include 'videos/filter_form.html' %}
        </div>
        
        <!-- Main Content -->
        <div class="col-12 col-md-9 col-lg-10">
            <div class="container-fluid py-3">
                {% if channel %}
                <div class="alert alert-info">
                    <strong>Channel:</strong> {{ channel.username }}
                </div>
                {% endif %}
                
                <!-- Video Grid (bigger cards: 2 cols mobile, 2-3 desktop) -->
                <div class="row row-cols-2 row-cols-lg-3 row-cols-xl-3 g-3">
                    {% for post in page_obj %}
                    <div class="col">
                        <div class="card video-card h-100" 
                             data-channel="{{ post.channel.username }}" 
                             data-post="{{ post.telegram_id }}"
                             data-link="{{ post.link }}"
                             data-text="{{ post.text|escape }}"
                             data-views="{{ post.views|default:'0' }}"
                             data-has-video="{{ post.video_data|yesno:'true,false' }}">
                            <div class="position-relative">
                                {% if post.video_data %}
                                <!-- Static thumbnail -->
                                <video class="card-img-top video-thumbnail" 
                                       preload="none">
                                </video>
                                <!-- Hover preview video (desktop only) -->
                                <video class="preview-video d-none d-md-block" 
                                       muted 
                                       loop 
                                       preload="none">
                                </video>
                                {% else %}
                                <div class="card-img-top video-thumbnail bg-secondary d-flex align-items-center justify-content-center text-white">
                                    <span style="font-size: 48px;">üì∑</span>
                                </div>
                                {% endif %}
                            </div>
                            <div class="card-body p-2">
                                <p class="card-text small mb-1" style="height: 40px; overflow: hidden; line-height: 1.3;">
                                    {{ post.text|truncatewords:10 }}
                                </p>
                                <div class="text-muted" style="font-size: 0.75rem;">
                                    <div>üëÅ {{ post.views|default:"0" }}</div>
                                    <div>{{ post.channel.username }}</div>
                                    <div class="post-datetime" data-datetime="{{ post.date.isoformat }}"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-12">
                        <div class="alert alert-warning">No posts found.</div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Pagination -->
                {% if page_obj.paginator.num_pages > 1 %}
                <nav aria-label="Page navigation" class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1{{ query_string }}">First</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{{ query_string }}">Previous</a>
                        </li>
                        {% endif %}
                        
                        <li class="page-item disabled">
                            <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
                        </li>
                        
                        {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{{ query_string }}">Next</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{{ query_string }}">Last</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Mobile Filter Button -->
<button class="btn btn-primary btn-filter d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#filterOffcanvas">
    üîç Filters
</button>

<!-- Mobile Offcanvas Filters -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="filterOffcanvas">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title">Filters</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
        {% include 'videos/filter_form.html' %}
    </div>
</div>

<!-- Video Modal -->
<div class="modal fade" id="videoModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark">
            <div class="modal-header border-0">
                <h5 class="modal-title text-white" id="videoModalTitle"></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div id="modalVideoContainer"></div>
            </div>
            <div class="modal-footer border-0 bg-dark">
                <div class="text-white small" id="modalVideoInfo"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Store video URLs to avoid re-fetching
const videoCache = {};

// Format datetime
function formatDateTime(isoString) {
    const date = new Date(isoString);
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
}

document.querySelectorAll('.post-datetime').forEach(el => {
    el.textContent = formatDateTime(el.dataset.datetime);
});

// Fetch video URL and cache it
async function getVideoUrl(channel, postId) {
    const cacheKey = `${channel}/${postId}`;
    if (videoCache[cacheKey]) {
        return videoCache[cacheKey];
    }
    
    try {
        const response = await fetch(`/api/video/${channel}/${postId}/`);
        const data = await response.json();
        videoCache[cacheKey] = data;
        return data;
    } catch (err) {
        console.error(`Failed to load video ${cacheKey}:`, err);
        return { video: null, thumbnail: null };
    }
}

// Initialize all video cards
document.querySelectorAll('.video-card').forEach(card => {
    const channel = card.dataset.channel;
    const postId = card.dataset.post;
    const hasVideo = card.dataset.hasVideo === 'true';
    
    if (!hasVideo) return;
    
    const thumbnail = card.querySelector('.video-thumbnail');
    const previewVideo = card.querySelector('.preview-video');
    let videoData = null;
    let isHovering = false;
    
    // Load thumbnail immediately
    getVideoUrl(channel, postId).then(data => {
        videoData = data;
        if (data.thumbnail && thumbnail) {
            thumbnail.poster = data.thumbnail;
        }
    });
    
    // Desktop hover preview
    if (previewVideo) {
        card.addEventListener('mouseenter', async () => {
            isHovering = true;
            if (!videoData) {
                videoData = await getVideoUrl(channel, postId);
            }
            
            if (videoData.video && isHovering) {
                previewVideo.src = videoData.video;
                previewVideo.classList.add('loaded');
                previewVideo.play().catch(err => {
                    console.log('Preview play failed:', err);
                });
            }
        });
        
        card.addEventListener('mouseleave', () => {
            isHovering = false;
            if (previewVideo) {
                previewVideo.pause();
                previewVideo.classList.remove('loaded');
            }
        });
    }
    
    // Click handler for modal (desktop) or fullscreen (mobile)
    card.addEventListener('click', async (e) => {
        e.stopPropagation();
        
        if (!videoData) {
            videoData = await getVideoUrl(channel, postId);
        }
        
        const isMobile = window.innerWidth < 768;
        
        if (isMobile) {
            // Mobile: try to play fullscreen directly
            if (videoData.video) {
                const tempVideo = document.createElement('video');
                tempVideo.src = videoData.video;
                tempVideo.controls = true;
                tempVideo.style.position = 'fixed';
                tempVideo.style.top = '0';
                tempVideo.style.left = '0';
                tempVideo.style.width = '100vw';
                tempVideo.style.height = '100vh';
                tempVideo.style.zIndex = '9999';
                tempVideo.style.backgroundColor = '#000';
                
                document.body.appendChild(tempVideo);
                
                tempVideo.requestFullscreen().then(() => {
                    tempVideo.play();
                }).catch(() => {
                    // Fallback if fullscreen fails
                    tempVideo.play();
                });
                
                tempVideo.addEventListener('ended', () => {
                    document.exitFullscreen().catch(() => {});
                    tempVideo.remove();
                });
                
                tempVideo.addEventListener('pause', () => {
                    setTimeout(() => {
                        document.exitFullscreen().catch(() => {});
                        tempVideo.remove();
                    }, 100);
                });
            } else {
                // No video available - open Telegram
                window.open(card.dataset.link, '_blank');
            }
        } else {
            // Desktop: show modal
            showVideoModal(card, videoData);
        }
    });
});

// Show video in Bootstrap modal (desktop)
function showVideoModal(card, videoData) {
    const modalEl = document.getElementById('videoModal');
    const modal = new bootstrap.Modal(modalEl);
    const container = document.getElementById('modalVideoContainer');
    const title = document.getElementById('videoModalTitle');
    const info = document.getElementById('modalVideoInfo');
    
    title.textContent = card.dataset.channel;
    info.innerHTML = `üëÅ ${card.dataset.views} views`;
    
    container.innerHTML = '';
    
    if (videoData.video) {
        // Video available - autoplay unmuted
        const video = document.createElement('video');
        video.src = videoData.video;
        video.controls = true;
        video.autoplay = true;
        video.style.width = '100%';
        video.style.maxHeight = '80vh';
        video.style.backgroundColor = '#000';
        
        if (videoData.thumbnail) {
            video.poster = videoData.thumbnail;
        }
        
        container.appendChild(video);
        
        // Clean up when modal closes
        modalEl.addEventListener('hidden.bs.modal', () => {
            video.pause();
            video.src = '';
        }, { once: true });
    } else {
        // Video too large - show fallback
        container.innerHTML = `
            <div class="fallback-container text-center p-5">
                <div class="text-white">
                    <h4 class="mb-3">üìπ Video too large to embed</h4>
                    <p class="mb-4">Telegram doesn't allow embedding large videos</p>
                    <a href="${card.dataset.link}" target="_blank" class="btn btn-primary btn-lg">
                        Open in Telegram to Watch
                    </a>
                </div>
            </div>
        `;
    }
    
    modal.show();
}
</script>
{% endblock %}
